<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Sanderson Novel Template Editor</title>
        <!-- Tailwind CDN with class-based dark mode -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>tailwind.config = { darkMode: 'class' };</script>
        <!-- Toast UI Editor CSS -->
        <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
        <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css" />
        <style>
        /* Toast UI dark theme overrides */
        .toastui-editor-dark .toastui-editor-defaultUI,
        .toastui-editor-dark .toastui-editor-contents,
        .toastui-editor-dark .toastui-editor-md-container,
        .toastui-editor-dark .toastui-editor-mode-switch,
        .toastui-editor-dark .toastui-editor-mode-switch .tab-item,
        .toastui-editor-dark .toastui-editor-toolbar button,
        .toastui-editor-dark .ProseMirror {
            background-color: #1a202c;
            color: #f7fafc;
        }
        .toastui-editor-dark .toastui-editor-toolbar,
        .toastui-editor-dark .toastui-editor-defaultUI-toolbar,
        .toastui-editor-dark .toastui-editor-dropdown-toolbar,
        .toastui-editor-dark .toastui-editor-mode-switch .tab-item.active,
        .toastui-editor-dark .toastui-editor-toolbar button:hover {
            background-color: #2d3748;
            color: #f7fafc;
        }
        .toastui-editor-dark .toastui-editor-separator {
            border-color: #4a5568;
        }
        .toastui-editor-dark .toastui-editor-contents h1,
        .toastui-editor-dark .toastui-editor-contents h2,
        .toastui-editor-dark .toastui-editor-contents h3,
        .toastui-editor-dark .toastui-editor-contents h4,
        .toastui-editor-dark .toastui-editor-contents h5,
        .toastui-editor-dark .toastui-editor-contents h6 {
            color: #f7fafc;
        }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
        <div class="max-w-5xl mx-auto p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold">Sanderson Novel Template Editor</h1>
                    <h2 id="author-name" class="text-xl text-gray-600 dark:text-gray-400">by Your Name</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="theme-toggle-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-600">Toggle Theme</button>
                    <button id="fullscreen-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-600">Fullscreen Edit</button>
                </div>
            </div>

            <!-- Selectors -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="plan-selector" class="block text-lg font-medium mb-2">Plan Files:</label>
                    <select id="plan-selector" class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
                        <option value="" disabled selected>Select a planâ€¦</option>
                    </select>
                </div>
                <div>
                    <label for="chapter-selector" class="block text-lg font-medium mb-2">Chapter Files:</label>
                    <select id="chapter-selector" class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
                        <option value="" disabled selected>Select a chapterâ€¦</option>
                    </select>
                </div>
            </div>

            <!-- File actions -->
            <div class="mb-4 flex gap-2">
                <button id="create-plan-btn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">+ New Plan File</button>
                <button id="create-chapter-btn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">+ New Chapter</button>
                <button id="stageAll-btn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Stage All</button>
            </div>

            <!-- Editor and Git controls -->
            <h3 id="file-header" class="text-xl font-semibold mb-4 hidden"></h3>
            <div id="file-git-controls" class="mb-4 flex gap-2 hidden">
                <button id="stage-file-btn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Stage File</button>
                <button id="unstage-file-btn" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Unstage File</button>
            </div>
            <div id="editor-container" class="hidden">
                <div id="editor" class="bg-white dark:bg-gray-800 rounded shadow mb-4"></div>
            </div>

            <!-- Git toolbar -->
            <div class="flex flex-wrap gap-2 my-4">
                <button id="git-status-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded">Git Status</button>
                <button id="git-log-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded">Git Log</button>
                <button id="git-diff-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded">Git Diff</button>
                <button id="commit-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Commit</button>
                <button id="push-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">Push</button>
                <button id="pull-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded">Pull</button>
                <button id="save-btn" class="px-4 py-2 bg-gray-700 dark:bg-gray-600 hover:bg-black dark:hover:bg-gray-800 text-white rounded">Save</button>
                <button id="delete-btn" class="px-4 py-2 bg-red-700 hover:bg-red-800 text-white rounded">Delete</button>
            </div>

            <!-- Commit message -->
            <textarea id="commit-msg" class="px-3 py-2 border rounded w-full mb-4 bg-white dark:bg-gray-800 dark:border-gray-600 dark=text-gray-100" placeholder="Commit message"></textarea>

            <!-- Git output -->
            <div id="git-output" class="bg-white dark:bg-gray-800 rounded shadow p-4 text-sm hidden">
                <h2 class="text-lg font-semibold mb-2">Git Output</h2>
                <div id="git-output-content" class="whitespace-pre-wrap font-mono text-sm"></div>
            </div>
        </div>

        <!-- Toast UI Editor full bundle -->
        <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
        <script>
        // Helpers for cookies and fullscreen
        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }
        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const [k, val] = v.split('='); return k === name ? decodeURIComponent(val) : r;
            }, '');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const htmlEl = document.documentElement;
            const themeBtn = document.getElementById('theme-toggle-btn');
            let mode = getCookie('theme') || 'light';
            htmlEl.classList.toggle('dark', mode === 'dark');
            htmlEl.classList.toggle('toastui-editor-dark', mode === 'dark');
            themeBtn.textContent = mode === 'dark' ? 'Light Mode' : 'Dark Mode';

            const defaultHeight = '600px';
            const editorContainer = document.getElementById('editor-container');

            // Editor setup
            const { Editor } = toastui;
            let editor = new Editor({
                el: document.getElementById('editor'),
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                height: defaultHeight,
                initialValue: '',
                theme: mode
            });

            // Theme toggle
            themeBtn.addEventListener('click', () => {
                mode = htmlEl.classList.toggle('dark') ? 'dark' : 'light';
                htmlEl.classList.toggle('toastui-editor-dark', mode === 'dark');
                setCookie('theme', mode);
                themeBtn.textContent = mode === 'dark' ? 'Light Mode' : 'Dark Mode';
                const content = editor.getMarkdown();
                editor.destroy();
                editor = new Editor({
                    el: document.getElementById('editor'),
                    initialEditType: 'wysiwyg',
                    previewStyle: 'vertical',
                    height: defaultHeight,
                    initialValue: content,
                    theme: mode
                });
            });

            // Fullscreen toggle and listener
            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    editorContainer.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            });
            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    editor.setHeight('100vh');
                } else {
                    editor.setHeight(defaultHeight);
                }
            });
            // Load and bind tabs
            async function loadTabs() {
                try {
                    const res = await fetch('/files');
                    const { plan, chapters } = await res.json();
                    const planSel = document.getElementById('plan-selector');
                    const chapSel = document.getElementById('chapter-selector');
                    planSel.innerHTML = '<option value="" disabled selected>Select a planâ€¦</option>';
                    chapSel.innerHTML = '<option value="" disabled selected>Select a chapterâ€¦</option>';
                    plan.forEach(f => planSel.appendChild(new Option(f.replace('.md',''), f)));
                    chapters.forEach(f => chapSel.appendChild(new Option(f.replace('.md',''), f)));
                    document.getElementById('file-header').classList.add('hidden');
                    document.getElementById('file-git-controls').classList.add('hidden');
                    document.getElementById('editor-container').classList.add('hidden');
                } catch (e) { console.error(e); }
            }

            async function loadFileContent(dir, file) {
                const header = document.getElementById('file-header');
                header.textContent = file;
                header.classList.remove('hidden');
                document.getElementById('file-git-controls').classList.remove('hidden');
                document.getElementById('editor-container').classList.remove('hidden');
                const text = await (await fetch(`/files/${dir}/${file}`)).text();
                editor.setMarkdown(text);
                currentDir = dir; currentFile = file;
            }

            document.getElementById('plan-selector').addEventListener('change', e => loadFileContent('plan', e.target.value));
            document.getElementById('chapter-selector').addEventListener('change', e => loadFileContent('chapters', e.target.value));

            document.getElementById('stage-file-btn').addEventListener('click', async () => {
                await fetch(`/git/add?filename=${currentDir}/${currentFile}`, { method: 'POST' });
                showOutput(`âœ… Staged ${currentFile}`);
            });
            document.getElementById('unstage-file-btn').addEventListener('click', async () => {
                await fetch(`/git/reset?filename=${currentDir}/${currentFile}`, { method: 'POST' });
                showOutput(`ðŸš« Unstaged ${currentFile}`);
            });

            document.getElementById('create-plan-btn').addEventListener('click', () => createFile('plan'));
            document.getElementById('create-chapter-btn').addEventListener('click', () => createFile('chapters'));
            async function createFile(sec) {
                const name = prompt('Filename without .md:'); if (!name) return;
                const r = await fetch(`/files/${sec}/${name}.md`, { method: 'POST' });
                if (r.ok) { loadTabs(); showOutput(`âœ… Created ${name}.md`); } else { const j = await r.json(); showOutput(`âŒ ${j.error}`); }
            }

            document.getElementById('stageAll-btn').addEventListener('click', async () => { await fetch('/git/add', { method: 'POST' }); showOutput('âœ… Staged all'); });
            document.getElementById('save-btn').addEventListener('click', async () => {
                if (!currentFile) return alert('Select a file');
                const c = editor.getMarkdown();
                await fetch(`/files/${currentDir}/${currentFile}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: c }) });
                alert('Saved');
            });
            document.getElementById('delete-btn').addEventListener('click', async () => {
                if (!currentFile) return alert('Select a file');
                if (confirm(`Delete ${currentFile}?`)) { await fetch(`/files/${currentDir}/${currentFile}`, { method: 'DELETE' }); loadTabs(); }
            });
            document.getElementById('git-status-btn').addEventListener('click', async () => {
                const { staged, unstaged, untracked } = 
                    await (await fetch('/git/status')).json();

                const html = `
<div class="flex flex-col space-y-0">
<div>
<strong>Changes to be committed:</strong>
<div class="ml-4 space-y-0 text-green-500 font-mono">
${
staged.length
? staged.map(f => `<div>${f}</div>`).join('')
: '<div><em>none</em></div>'
}
</div>
</div>
<div>
<strong>Changes not staged for commit:</strong>
<div class="ml-4 space-y-0 text-yellow-500 font-mono">
${
unstaged.length
? unstaged.map(f => `<div>${f}</div>`).join('')
: '<div><em>none</em></div>'
}
</div>
</div>
<div>
<strong>Untracked files:</strong>
<div class="ml-4 space-y-0 text-red-500 font-mono">
${
untracked.length
? untracked.map(f => `<div>${f}</div>`).join('')
: '<div><em>none</em></div>'
}
</div>
</div>
</div>
`;

                const box     = document.getElementById('git-output');
                const content = document.getElementById('git-output-content');
                content.innerHTML = html;
                box.classList.remove('hidden');
            });

            document.getElementById('git-log-btn').addEventListener('click', async () => {
                const logs = await (await fetch('/git/log')).json();

                const html = `
<div class="flex flex-col space-y-1">
${logs.map(c => `
<div class="flex items-baseline gap-2">
<span class="text-green-400 font-mono">${c.hexsha}</span>
<span class="flex-1">${c.message}</span>
</div>
`).join('')}
</div>
`;

                const box     = document.getElementById('git-output');
                const content = document.getElementById('git-output-content');
                content.innerHTML = html;
                box.classList.remove('hidden');
            });
            document.getElementById('git-diff-btn').addEventListener('click', async () => {
                const { diff } = await (await fetch('/git/diff')).json();
                const html = diff.split('\n').map(l => {
                    const e = l.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    if (l.startsWith('+') && !l.startsWith('+++')) return `<div class=\"bg-green-100 dark:bg-gray-800 text-green-800 dark:text-green-400 font-mono whitespace-pre-wrap\">${e}</div>`;
                    if (l.startsWith('-') && !l.startsWith('---')) return `<div class=\"bg-red-100 dark:bg-gray-800 text-red-800 dark:text-red-400 font-mono whitespace-pre-wrap\">${e}</div>`;
                    return `<div class=\"font-mono whitespace-pre-wrap\">${e}</div>`;
                }).join('');
                const box = document.getElementById('git-output');
                document.getElementById('git-output-content').innerHTML = html;
                box.classList.remove('hidden');
            });

            document.getElementById('commit-btn').addEventListener('click', async () => {
                const m = document.getElementById('commit-msg').value.trim(); if (!m) return alert('Enter commit msg');
                const d = await (await fetch('/git/commit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(m) })).json();
                showOutput(`Committed: ${d.message}`);
            });
            document.getElementById('push-btn').addEventListener('click', async () => { await fetch('/git/push', { method: 'POST' }); showOutput('Pushed'); });
            document.getElementById('pull-btn').addEventListener('click', async () => { await fetch('/git/pull', { method: 'POST' }); showOutput('Pulled'); });

            function showOutput(t) {
                const box = document.getElementById('git-output');
                document.getElementById('git-output-content').textContent = t;
                box.classList.remove('hidden');
            }

            loadTabs();
        });
        </script>
    </body>
</html>

